@page "/configuration/{organizationId}/{realmId}/{sectionId}/{habitatId}"
@inject HttpClient client;
@using Allard.Configinator.Blazor.Shared.ViewModels
@using System.Text.Json
<h3>Configuration</h3>

@code {

    [Parameter]
    public string OrganizationId { get; set; }

    [Parameter]
    public string RealmId { get; set; }

    [Parameter]
    public string SectionId { get; set; }

    [Parameter]
    public string HabitatId { get; set; }

    public bool Edit { get; set; }


    private ExplainedViewModel explained;
    private SaveResponseViewModel SaveResponse;
    public string Json { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var url = $"/api/v1/config/{OrganizationId}/{RealmId}/{SectionId}/{HabitatId}/value-explained";
        explained = await client.GetFromJsonAsync<ExplainedViewModel>(url);
        await Load();
    }

    private async Task Load()
    {
        var url = $"/api/v1/config/{OrganizationId}/{RealmId}/{SectionId}/{HabitatId}/value-explained";
        explained = await client.GetFromJsonAsync<ExplainedViewModel>(url);
    }
    
    private async Task CancelEdit()
    {
        Edit = false;
        // todo: this should be a FORM RESET or something. brute force for now.
        await Load();
    }


    public async Task Save()
    {
        var result = new Dictionary<string, object>();
        foreach (var p in explained.Properties)
        {
            result[p.Name] = ToDictionary(p);
        }

        Json = JsonSerializer.Serialize(result);
        var url = $"/api/v1/config/{OrganizationId}/{RealmId}/{SectionId}/{HabitatId}/value-resolved";
        var x = await client.PutAsJsonAsync(url, result);
        SaveResponse = await x.Content.ReadFromJsonAsync<SaveResponseViewModel>();
        if (SaveResponse is {Success: true })
        {
            Edit = false;
            await Load();
        }
    }

    private Dictionary<string, object> ToDictionary(ExplainedProperty property)
    {
        var result = new Dictionary<string, object>();
        foreach (var p in property.Children)
        {
            Console.WriteLine("=====" + p.Name);
            if (p.Children.Count > 0)
            {
                result[p.Name] = ToDictionary(p);
                continue;
            }

            // if the value is null, don't set it.
            // the lack of the property will allow
            // it to inherit from the base.
            // if its explicitly set to anything,
            // including null, the value isn't inherited.
            var value = GetJsonValue(p.Value);
            if (value != null)
            {
                result[p.Name] = value;
            }
        }
        return result;
    }

    private static object GetJsonValue(object value)
    {
        if (value == null)
        {
            return value;
        }

        if (value is string s)
        {
            return string.IsNullOrWhiteSpace(s) ? null : s;
        }

        return value;
    }

    
}

<h1>@OrganizationId/@RealmId/@SectionId/@HabitatId</h1>

@if (SaveResponse != null)
{
    <ul>
        @foreach (var error in SaveResponse.Failures)
        {
            <li>@(error.Code == "RequiredPropertyValueMissing" ? "Required" : error.Code) : @error.Path</li>
        }
    </ul>
}

@if (explained != null)
{
    foreach (var p in explained.Properties)
    {
        <ConfigurationSection Edit=@Edit Property=@p/>
    }

    <button hidden="@(!Edit)" @onclick="Save">Save</button>
    <h1 hidden>@Json</h1>
    <button hidden="@Edit" @onclick="@(() => Edit=true)">Edit</button>
    <button hidden="@(!Edit)" @onclick="CancelEdit">Cancel</button>
}
